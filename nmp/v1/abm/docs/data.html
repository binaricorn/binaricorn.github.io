<!DOCTYPE html>

<html>
<head>
  <title>data.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="algorithm.html">
                  algorithm.coffee
                </a>
              
                
                <a class="source" href="as.dat.gui.html">
                  as.dat.gui.js
                </a>
              
                
                <a class="source" href="data.html">
                  data.coffee
                </a>
              
                
                <a class="source" href="data.tile.html">
                  data.tile.js
                </a>
              
                
                <a class="source" href="fbui.html">
                  fbui.coffee
                </a>
              
                
                <a class="source" href="mouse.html">
                  mouse.coffee
                </a>
              
                
                <a class="source" href="nlmouse.html">
                  nlmouse.coffee
                </a>
              
                
                <a class="source" href="rgbtohsl.html">
                  rgbtohsl.coffee
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>data.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>DataSet is an addon for managing data arrays.</p>
<p>DataSets do not need to be the same size as the patch sets. Rather they have
methods for sampling and creating new datasets of any width/height.
They also cam set patch variables resampled to the patch width/height.
Several utilities are provided for creating datasets from Image and
XmlHTTPRequest inputs, and for drawing into the patch drawing layer.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Two specific subclasses are provided for Asc GIS elevation data,
and an image-as-data class.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
u = ABM.Util
ABM.DataSet = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataSet</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Static members:</p>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Create a new dataset using function f on each patch.
If f is string, f set to fcn returning p[f]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  @patchDataSet: <span class="hljs-function"><span class="hljs-params">(f)</span> -&gt;</span> <span class="hljs-keyword">new</span> PatchDataSet f</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Create a new dataset from an image file name.
Note that datasets can be built in two steps:
An empty constructor which then can be completed by an
async array, Image or XHR response.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  @importImageDataSet: <span class="hljs-function"><span class="hljs-params">(name, f, format=u.pixelByte(<span class="hljs-number">0</span>), arrayType=Uint8ClampedArray, rowsPerSlice)</span> -&gt;</span>
    ds = <span class="hljs-keyword">new</span> ImageDataSet(<span class="hljs-literal">null</span>, format, arrayType, rowsPerSlice) <span class="hljs-comment"># empty dataset</span>
    u.importImage name, <span class="hljs-function"><span class="hljs-params">(img)</span> -&gt;</span> <span class="hljs-comment"># =&gt; not needed</span>
      ds.parse img
      f(ds) <span class="hljs-keyword">if</span> f?
    ds <span class="hljs-comment"># async: ds will be empty until import finishes</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Create a new dataset from an Asc GIS file.
The parse method converts a string into a dataset. Async</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  @importAscDataSet: <span class="hljs-function"><span class="hljs-params">(name, f)</span> -&gt;</span>
    ds = <span class="hljs-keyword">new</span> AscDataSet() <span class="hljs-comment"># empty dataset</span>
    u.xhrLoadFile name, <span class="hljs-string">"GET"</span>, <span class="hljs-string">"text"</span>, <span class="hljs-function"><span class="hljs-params">(response)</span> -&gt;</span> <span class="hljs-comment"># -&gt; OK, closure</span>
      ds.parse response <span class="hljs-comment"># complete the empty dataset</span>
      f(ds) <span class="hljs-keyword">if</span> f?
    ds <span class="hljs-comment"># async: ds will be empty until import finishes</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>2D Dataset: width/height and an array with length = width*height</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: <span class="hljs-function"><span class="hljs-params">(width=<span class="hljs-number">0</span>, height=<span class="hljs-number">0</span>, data=[], @model)</span> -&gt;</span>
    @setDefaults()
    @reset width, height, data</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Reset a dataset to have new width, height and data.  Allows creating
an empty dataset and having it filled by another function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset: <span class="hljs-function"><span class="hljs-params">(@width, @height, @data)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> @data.length <span class="hljs-keyword">isnt</span> @width*@height
      u.error <span class="hljs-string">"""DataSet: data array length error:
      data.length: <span class="hljs-subst">#{@data.length}</span> width: <span class="hljs-subst">#{@width}</span> height: <span class="hljs-subst">#{@height}</span>
      """</span>
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Check that x,y are valid coords (floats), from top-left of dataset.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  checkXY: <span class="hljs-function"><span class="hljs-params">(x,y)</span> -&gt;</span>
    u.error <span class="hljs-string">"x,y out of range: <span class="hljs-subst">#{x}</span>,<span class="hljs-subst">#{y}</span>"</span> <span class="hljs-keyword">unless</span> (<span class="hljs-number">0</span>&lt;=x&lt;=@width<span class="hljs-number">-1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span>&lt;=y&lt;=@height<span class="hljs-number">-1</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Set dataset transform parameters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setDefaults: <span class="hljs-function">-&gt;</span>
    @useNearest=<span class="hljs-literal">false</span>
    @crop=<span class="hljs-literal">false</span>
    @normalizeImage=<span class="hljs-literal">true</span>
    @alpha=<span class="hljs-number">255</span>
    @gray=<span class="hljs-literal">true</span>
  setSampler: <span class="hljs-function"><span class="hljs-params">(@useNearest)</span> -&gt;</span>
  setConvolveCrop: <span class="hljs-function"><span class="hljs-params">(@crop)</span> -&gt;</span>
  setImageNormalize: <span class="hljs-function"><span class="hljs-params">(@normalizeImage)</span> -&gt;</span>
  setImageAlpha: <span class="hljs-function"><span class="hljs-params">(@alpha)</span> -&gt;</span> <span class="hljs-comment"># pixel alpha: [0,255]</span>
  setImageGray: <span class="hljs-function"><span class="hljs-params">(@gray)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Set the model to use by default for things like <code>toPatchVar()</code>,
<code>toDrawing()</code>, and <code>toPatchColors()</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setModel: <span class="hljs-function"><span class="hljs-params">(@model)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Sample the dataset.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sample: <span class="hljs-function"><span class="hljs-params">(x,y)</span> -&gt;</span> <span class="hljs-keyword">if</span> @useNearest <span class="hljs-keyword">then</span> @nearest x,y <span class="hljs-keyword">else</span> @bilinear x,y</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Sample dataset using nearest neighbor. x,y floats in range</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  nearest: <span class="hljs-function"><span class="hljs-params">(x,y)</span> -&gt;</span> @getXY Math.round(x), Math.round(y)</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Sample dataset using bilinear (2D) interpolation. x,y floats in range</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  bilinear: <span class="hljs-function"><span class="hljs-params">(x,y)</span> -&gt;</span> <span class="hljs-comment"># http://en.wikipedia.org/wiki/Bilinear_interpolation</span>
    @checkXY x,y
    x0=Math.floor x; y0=Math.floor y; i=@toIndex x0,y0; w=@width</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Edge case: If x is width-1, x0 is width-1, x is 0, dx is 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    x=x-x0; y=y-y0; dx=<span class="hljs-number">1</span>-x; dy=<span class="hljs-number">1</span>-y</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Edge case: fij is 0 if beyond data array; undefined -&gt; 0
if fij wrap on x, x is 0, dx is 1; return f00<em>dy+f01</em>y, linear on y</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    f00=@data[i]; f01=@data[i+w] ? <span class="hljs-number">0</span>; f10=@data[++i] ? <span class="hljs-number">0</span>; f11=@data[i+w] ? <span class="hljs-number">0</span>
    f00*dx*dy + f10*x*dy + f01*dx*y + f11*x*y</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Convert x,y ints to index into data array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toIndex: <span class="hljs-function"><span class="hljs-params">(x,y)</span> -&gt;</span> x + y*@width</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Convert int index into data array into x,y ints</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toXY: <span class="hljs-function"><span class="hljs-params">(i)</span> -&gt;</span> [i % @width, Math.floor i/@width]</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Get data at x,y int offset into data array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getXY: <span class="hljs-function"><span class="hljs-params">(x,y)</span> -&gt;</span> @checkXY x,y; @data[@toIndex x,y]</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Set the data and int x,y coord of data array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setXY: <span class="hljs-function"><span class="hljs-params">(x,y,num)</span> -&gt;</span> @checkXY x,y; @data[@toIndex x,y] = num</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Return a printable string for dataset.
If p &lt; 0, print data, otherwise use toFixed to truncate to p precision</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toString: <span class="hljs-function"><span class="hljs-params">(p=<span class="hljs-number">2</span>, sep=<span class="hljs-string">", "</span>)</span>-&gt;</span>
    s = <span class="hljs-string">"width: <span class="hljs-subst">#{@width}</span> height: <span class="hljs-subst">#{@height}</span> data:"</span>
    data = <span class="hljs-keyword">if</span> p&lt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> @data <span class="hljs-keyword">else</span> u.aToFixed @data, p
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..@height]
      s += <span class="hljs-string">"\n"</span> + <span class="hljs-string">"<span class="hljs-subst">#{i}</span>: <span class="hljs-subst">#{data.slice i*@width, (i+<span class="hljs-number">1</span>)*@width}</span>"</span>
    s.replace <span class="hljs-regexp">/,/g</span>, sep</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Convert dataset into an image.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toImage: <span class="hljs-function">-&gt;</span> @toContext().canvas
  toContext: <span class="hljs-function">-&gt;</span>
    ctx = u.createCtx @width, @height
    idata = ctx.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, @width, @height); ta = idata.data
    <span class="hljs-keyword">if</span> @normalizeImage
      data = <span class="hljs-keyword">if</span> @gray <span class="hljs-keyword">then</span> u.normalize8 @data <span class="hljs-keyword">else</span> u.normalizeInt @data, <span class="hljs-number">0</span>, Math.pow(<span class="hljs-number">2</span>,<span class="hljs-number">24</span>)<span class="hljs-number">-1</span>
    <span class="hljs-keyword">else</span>
      data = (Math.round d <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> @data)
    <span class="hljs-keyword">for</span> num, i <span class="hljs-keyword">in</span> data
      j=<span class="hljs-number">4</span>*i
      <span class="hljs-keyword">if</span> @gray
        ta[j] = ta[j+<span class="hljs-number">1</span>] = ta[j+<span class="hljs-number">2</span>] = Math.floor num
        ta[j+<span class="hljs-number">3</span>] = @alpha
      <span class="hljs-keyword">else</span>
        ta[j]=(num&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xff</span>; ta[j+<span class="hljs-number">1</span>]=(num&gt;&gt;<span class="hljs-number">8</span>)&amp;<span class="hljs-number">0xff</span>; ta[j+<span class="hljs-number">2</span>]=num&amp;<span class="hljs-number">0xff</span>
        ta[j+<span class="hljs-number">3</span>] = <span class="hljs-keyword">if</span> @normalizeImage <span class="hljs-keyword">then</span> @alpha <span class="hljs-keyword">else</span> ta[j+<span class="hljs-number">3</span>]=(num&gt;&gt;<span class="hljs-number">24</span>)&amp;<span class="hljs-number">0xff</span>
    ctx.putImageData idata, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
    ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Get a data url representing this dataset as an image. Useful for
debugging: console.log the data url to the console and open it
in a new browser tab for viewing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toDataUrl: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> u.ctxToDataUrl @toContext()</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Show dataset as image in patch drawing layer or patch colors, return image</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toDrawing: <span class="hljs-function"><span class="hljs-params">(model = @model)</span> -&gt;</span> model.patches.installDrawing(img=@toImage()); img
  toPatchColors: <span class="hljs-function"><span class="hljs-params">(model = @model)</span> -&gt;</span> model.patches.installColors(img=@toImage()); img</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Resample dataset to patch width/height and set named patch variable.
Note this “insets” the dataset so the variable is sampled the center of the patch.
The dataset can be sampled directly to its edges .. i.e. in turtle coords.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toPatchVar: <span class="hljs-function"><span class="hljs-params">(name, model = @model)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> (ps=model.patches).length <span class="hljs-keyword">is</span> @data.length
    <span class="hljs-keyword">then</span> p[name] = @data[i] <span class="hljs-keyword">for</span> p,i <span class="hljs-keyword">in</span> ps
    <span class="hljs-keyword">else</span> p[name] = @patchSample p.x, p.y, model <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> ps
    <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Sample via transformed coords.
x,y is in topleft-bottomright box: [tlx,tly,tlx+w,tly-h]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  coordSample: <span class="hljs-function"><span class="hljs-params">(x, y, tlx, tly, w, h)</span> -&gt;</span> <span class="hljs-comment">#brx, bry) -&gt;</span>
    xs=(x-tlx)*(@width<span class="hljs-number">-1</span>)/w;  ys=(tly-y)*(@height<span class="hljs-number">-1</span>)/h <span class="hljs-comment"># convert to sample space</span>
    @sample xs,ys
  patchSample: <span class="hljs-function"><span class="hljs-params">(px, py, model = @model)</span> -&gt;</span>
    w=model.world
    @coordSample px, py, w.minXcor, w.maxYcor, w.numX, w.numY</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Normalize a dataset to linear interpolation: [min,max] -&gt; [lo, hi], float</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  normalize: <span class="hljs-function"><span class="hljs-params">(lo, hi)</span> -&gt;</span> <span class="hljs-keyword">new</span> DataSet @width, @height, u.normalize(@data, lo, hi), @model</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Normalize a dataset to clamped Uint8 bytes [0-255]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  normalize8: <span class="hljs-function">-&gt;</span> <span class="hljs-keyword">new</span> DataSet @width, @height, u.normalize8(@data), @model</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Resample dataset to new width, height</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  resample: <span class="hljs-function"><span class="hljs-params">(width, height)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DataSet width,height,@data,@model <span class="hljs-keyword">if</span> width <span class="hljs-keyword">is</span> @width <span class="hljs-keyword">and</span> height <span class="hljs-keyword">is</span> @height
    data = []; xScale = (@width<span class="hljs-number">-1</span>)<span class="hljs-regexp">/(width-1); yScale = (@height-1)/</span>(height<span class="hljs-number">-1</span>)
    <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..height] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
      <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..width] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
        xs=x*xScale; ys=y*yScale
        data.push @sample xs,ys
    <span class="hljs-keyword">new</span> DataSet width, height, data, @model</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Return neighbor values of the given x,y of the dataset.
Off-edge neighbors revert to nearest edge value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  neighborhood: <span class="hljs-function"><span class="hljs-params">(x,y,array=[])</span> -&gt;</span> <span class="hljs-comment"># return 3x3 neighborhood</span>
    array.length = <span class="hljs-number">0</span> <span class="hljs-comment"># in case user supplied an array</span>
    <span class="hljs-keyword">for</span> dy <span class="hljs-keyword">in</span> [<span class="hljs-number">-1.</span><span class="hljs-number">.1</span>]
      <span class="hljs-keyword">for</span> dx <span class="hljs-keyword">in</span> [<span class="hljs-number">-1.</span><span class="hljs-number">.1</span>]
        x0=u.clamp x+dx, <span class="hljs-number">0</span>, @width<span class="hljs-number">-1</span>
        y0=u.clamp y+dy, <span class="hljs-number">0</span>, @height<span class="hljs-number">-1</span>
        array.push @data[@toIndex x0, y0]
    array</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Return a new dataset of same size convolved with the given kernel 3x3 matrix.
See <a href="http://goo.gl/ubFiji">Convolution article</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  convolve: <span class="hljs-function"><span class="hljs-params">(kernel,factor=<span class="hljs-number">1</span>)</span> -&gt;</span> <span class="hljs-comment"># Factory: return new convolved dataset</span>
    array = []; n = []
    <span class="hljs-keyword">if</span> @crop
    <span class="hljs-keyword">then</span> x0=y0=<span class="hljs-number">1</span>; h=@height<span class="hljs-number">-1</span>; w=@width<span class="hljs-number">-1</span>
    <span class="hljs-keyword">else</span> x0=y0=<span class="hljs-number">0</span>; h=@height; w=@width
    <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> [y0...h] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
      <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> [x0...w] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
        @neighborhood x,y,n
        array.push u.aSum(u.aPairMul(kernel, n))*factor
    <span class="hljs-keyword">new</span> DataSet w-x0, h-y0, array, @model</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>A few common convolutions.  dzdx/y are also called horiz/vert Sobel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  dzdx: <span class="hljs-function"><span class="hljs-params">(n=<span class="hljs-number">2</span>,factor=<span class="hljs-number">1</span>/<span class="hljs-number">8</span>)</span> -&gt;</span> @convolve([<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,-n,<span class="hljs-number">0</span>,n,<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>],factor)
  dzdy: <span class="hljs-function"><span class="hljs-params">(n=<span class="hljs-number">2</span>,factor=<span class="hljs-number">1</span>/<span class="hljs-number">8</span>)</span> -&gt;</span> @convolve([<span class="hljs-number">1</span>,n,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">-1</span>,-n,<span class="hljs-number">-1</span>],factor)
  laplace8: <span class="hljs-function">-&gt;</span> @convolve([<span class="hljs-number">-1</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">8</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">-1</span>])
  laplace4: <span class="hljs-function">-&gt;</span> @convolve([<span class="hljs-number">0</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">4</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>])
  blur: <span class="hljs-function"><span class="hljs-params">(factor=<span class="hljs-number">0.0625</span>)</span> -&gt;</span> @convolve([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>], factor) <span class="hljs-comment"># 1/16 = 0.0625</span>
  edge: <span class="hljs-function">-&gt;</span> @convolve([<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">-7</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>])</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Return filtered dataset by applying f to each dataset element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  filter: <span class="hljs-function"><span class="hljs-params">(f)</span> -&gt;</span> <span class="hljs-keyword">new</span> DataSet @width, @height, (f(d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> @data), @model</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Create two new convolved datasets, slope and aspect, common in
the use of an elevation data set. See Esri tutorials for
<a href="http://goo.gl/ZcOl08">slope</a> and <a href="http://goo.gl/KoI4y5">aspect</a>
It also returns the two derivitive DataSets, dzdx, dzdy for
those wanting to use the results of the two convolutions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  slopeAndAspect: <span class="hljs-function"><span class="hljs-params">(noNaNs=<span class="hljs-literal">true</span>, posAngle=<span class="hljs-literal">true</span>)</span> -&gt;</span>
    dzdx = @dzdx() <span class="hljs-comment"># sub left z from right</span>
    dzdy = @dzdy() <span class="hljs-comment"># sub bottom z from top</span>
    aspect = []; slope = []; h = dzdx.height; w = dzdx.width
    <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..h] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
      <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..w] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
        gx = dzdx.getXY(x,y); gy = dzdy.getXY(x,y)
        slope.push Math.atan(Math.sqrt(gx*gx + gy*gy)) <span class="hljs-comment">#/(@cellsize)) # radians</span>
        <span class="hljs-keyword">while</span> noNaNs <span class="hljs-keyword">and</span> gx <span class="hljs-keyword">is</span> gy
          gx += u.randomNormal <span class="hljs-number">0</span>,<span class="hljs-number">.0001</span>; gy += u.randomNormal <span class="hljs-number">0</span>,<span class="hljs-number">.0001</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>radians in [-PI,PI], downhill</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        rad = <span class="hljs-keyword">if</span> gx <span class="hljs-keyword">is</span> gy <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> NaN <span class="hljs-keyword">else</span> Math.atan2 -gy,-gx</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>positive radians in [0,2PI] if desired</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        rad += <span class="hljs-number">2</span>*Math.PI <span class="hljs-keyword">if</span> posAngle <span class="hljs-keyword">and</span> rad &lt; <span class="hljs-number">0</span>
        aspect.push rad
    slope = <span class="hljs-keyword">new</span> DataSet w, h, slope, @model
    aspect = <span class="hljs-keyword">new</span> DataSet w, h, aspect, @model
    u.aToObj [slope, aspect, dzdx, dzdy], [<span class="hljs-string">"slope"</span>, <span class="hljs-string">"aspect"</span>, <span class="hljs-string">"dzdx"</span>, <span class="hljs-string">"dzdy"</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Return a subset of the dataset. x,y,width,height integers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  subset: <span class="hljs-function"><span class="hljs-params">(x, y, width, height)</span> -&gt;</span>
    u.error <span class="hljs-string">"subSet: params out of range"</span> <span class="hljs-keyword">if</span> x+width&gt;@width <span class="hljs-keyword">or</span> y+height&gt;@height
    data = []
    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> [y...y+height] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
      <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [x...x+width] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
        data.push @getXY i,j
    <span class="hljs-keyword">new</span> DataSet width, height, data, @model

ABM.AscDataSet = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AscDataSet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DataSet</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>An .asc GIS file a text file with a header:</p>
<pre><code>ncols <span class="hljs-number">195</span>
nrows <span class="hljs-number">195</span>
xllcorner <span class="hljs-number">-84.355652</span>
yllcorner <span class="hljs-number">39.177963</span>
cellsize <span class="hljs-number">0.000093</span>
NODATA_value <span class="hljs-number">-9999</span>
</code></pre><p>..followed by a ncols X nrows matrix of numbers</p>

            </div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Constructor takes a string generally via an xhr request.
It can be “empty” .. i.e. needing a second parse() call
so that it can be used in an async file operation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: <span class="hljs-function"><span class="hljs-params">(@str=<span class="hljs-string">""</span>, @model)</span> -&gt;</span>
    <span class="hljs-keyword">super</span>() <span class="hljs-comment"># start out as an empty dataset</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> @str.length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
    @parse @str</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Complete an initial, empty dataset object who’s string
is read via an xhr request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  parse: <span class="hljs-function"><span class="hljs-params">(@str)</span> -&gt;</span>
    textData = @str.split <span class="hljs-string">"\n"</span>; @header = {}; <span class="hljs-comment">#gisData.data = []</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span><span class="hljs-number">.5</span>]
      keyVal = textData[i].split <span class="hljs-regexp">/\s+/</span>
      @header[keyVal[<span class="hljs-number">0</span>].toLowerCase()] = parseFloat keyVal[<span class="hljs-number">1</span>]
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..@header.nrows] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
      nums = textData[<span class="hljs-number">6</span>+i].trim().split(<span class="hljs-string">" "</span>)
      nums[i] = parseFloat nums[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..nums.length]
      @data = @data.concat nums
    @reset @header.ncols, @header.nrows, @data

ABM.ImageDataSet = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageDataSet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DataSet</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>An image-as-data dataset.  The parser takes an image
data Uint8Array, enumerates it in 4-byte segments converting
the segments into a data element for the given array type.
If rowsPerSlice is set, incrementally traverse image in image
slice of that height; used for huge images.
Defaults to gray scale and Uint8ClampedArray
img may be a canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: <span class="hljs-function"><span class="hljs-params">(img, @f=u.pixelByte(<span class="hljs-number">0</span>), @arrayType=Uint8ClampedArray, @rowsPerSlice, @model)</span> -&gt;</span>
    <span class="hljs-keyword">super</span>() <span class="hljs-comment"># start out as an empty dataset</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> img?
    @parse img
  parse: <span class="hljs-function"><span class="hljs-params">(img)</span> -&gt;</span>
    @rowsPerSlice <span class="hljs-keyword">or</span>= img.height
    data = u.imageRowsToData img, @rowsPerSlice, @f, @arrayType
    @reset img.width, img.height, data

ABM.PatchDataSet = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PatchDataSet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DataSet</span></span>
  constructor: <span class="hljs-function"><span class="hljs-params">(f, arrayType=Array, @model)</span> -&gt;</span>
    data = <span class="hljs-keyword">new</span> arrayType (ps=@model.patches).length
    f = u.propFcn f <span class="hljs-keyword">if</span> u.isString f
    data[i] = f(p) <span class="hljs-keyword">for</span> p,i <span class="hljs-keyword">in</span> ps
    <span class="hljs-keyword">super</span> ps.numX, ps.numY, data
    @useNearest = <span class="hljs-literal">true</span>
  toPatchVar: <span class="hljs-function"><span class="hljs-params">(name)</span> -&gt;</span>
    p[name] = @data[i] <span class="hljs-keyword">for</span> p,i <span class="hljs-keyword">in</span> @model.patches; <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
